version: 2
jobs:
  build:
    branchs:
      - master
    docker:
      - image: circleci/php:7.1-browsers

    working_directory: ~/repo

    steps:
      - checkout

      - add_ssh_keys:
          fingerprints:
            - "8a:f4:64:2c:0e:42:87:c5:3c:cf:f4:4d:ae:77:df:45"

      - run:
          name: Start ssh-keyscan
          command: |
            ssh-keyscan ${HOST_NAME_AZURE} >> ~/.ssh/known_hosts

      - deploy:
          name: Start Azure Deploy:Git Clone
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              ssh ${USER_NAME_AZURE}@${HOST_NAME_AZURE} "/bin/bash" < ./clone.sh
            fi
      - deploy:
          name: Start Azure Deploy:Shell
          command: |
            if [ "${CIRCLE_BRANCH}" == "nobranch" ]; then
              ssh ${USER_NAME_AZURE}@${HOST_NAME_AZURE} "cd /var/www/html/web;sudo sh deploy.sh nginx;"
            fi
      - deploy:
          name: Start Azure Deploy:Ansible
          command: |
            if [ "${CIRCLE_BRANCH}" == "nobranch" ]; then
              ssh ${USER_NAME_AZURE}@${HOST_NAME_AZURE} "cd /var/www/html/ansible;sudo ansible-playbook -i inv/hosts test.yml;"
            fi
      - deploy:
          name: Start Azure Deploy:Deployer
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              ssh ${USER_NAME_AZURE}@${HOST_NAME_AZURE} "cd /var/www/html/web/;composer install;sudo dep deploy develop;"
            fi
